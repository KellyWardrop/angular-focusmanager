/*
* uxFocusManager v.0.0.1
* (c) 2014, WebUX
* https://github.com/webux/ux-angular-focusmanager
* License: MIT.
*/
!function(a,b){b.ux=a,function(){var a;try{a=angular.module("ux")}catch(b){a=angular.module("ux",[])}a.directive("focusElement",function(a,b){function c(c,d){var e=d[0];b.isAutofocus(e)&&setTimeout(function(){a.focus(e)})}return{link:c}}),a.directive("focusGroup",function(a){function b(b){var c,f,g,h,i="group-"+d;for(a.setGroupId(b,i),c=a.getElementsWithoutParents(b),g=c.length,f=0;g>f;)h="element-"+e,a.setParentId(c[f],i),a.setElementId(c[f],h),e+=1,f+=1;for(c=a.getGroupsWithoutContainers(b),g=c.length,f=0;g>f;)a.setContainerId(c[f],i),f+=1;d+=1}function c(a,c){b(c[0])}var d=1,e=1;return{link:c}}),String.prototype.supplant=function(a){"use strict";return this.replace(/{([^{}]*)}/g,function(b,c){var d=a[c];return"string"==typeof d||"number"==typeof d?d:b})},a.service("focus",function(a){document.addEventListener("focusout",function(b){b.preventDefault(),b.stopImmediatePropagation(),a.focus(a.focus())},!1),document.addEventListener("focusin",function(a){a.preventDefault(),a.stopImmediatePropagation()},!1)}).run(function(){}),a.service("focusKeyboard",function(){function a(a,b){e[a.trim().toLowerCase()]={muted:!1,callback:b}}function b(a){delete e[a.trim().toLowerCase()]}function c(a){var b=e[a.trim().toLowerCase()];b&&(b.muted=!0)}function d(a){var b=e[a.trim().toLowerCase()];b&&(b.muted=!1)}var e={};document.addEventListener("keydown",function(a){var b="";a.shiftKey&&(b+="shift+"),9===a.keyCode&&(b+="tab");var c=e[b];c&&c.callback&&!c.muted&&(a.preventDefault(),a.stopPropagation(),c.callback())}),this.register=a,this.unregister=b,this.mute=c,this.unmute=d}).run(function(a,b){a.register("TAB",b.next),a.register("SHIFT+TAB",b.prev)}),a.service("focusManager",function(a){document.addEventListener("focusin",function(b){a.focus(b.target)})}).run(function(){}),a.service("focusModel",function(a){function b(a){return"undefined"==typeof a?q.activeElement:(q.activeElement=a,void a.focus())}function c(b){return a.canReceiveFocus(b)}function d(){var b,c;q.activeElement?(b=a.getParentId(q.activeElement),c=a.getElementId(q.activeElement),m(b,c)):m()}function e(){var b,c;q.activeElement?(b=a.getParentId(q.activeElement),c=a.getElementId(q.activeElement),p(b,c)):p()}function f(a,b){for(var c=0,d=a.length;d>c;){if(a[c]===b)return c;c+=1}return-1}function g(b,c){var d,e;if(b&&b.length){if(!c)return b[b.length-1];if(d=a.getElement(c),e=f(b,d),e>0)return b[e-1]}}function h(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getGroup(c),e=f(b,d),e>0)return b[e-1]}}function i(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getElement(c),e=f(b,d),-1!==e&&e+1<b.length)return b[e+1]}}function j(b,c){var d,e;return b&&(d=a.getGroup(c),e=f(b,d),-1!==e&&e+1<b.length)?b[e+1]:void 0}function k(b,c){var d,e,f,g,h;c?(d=a.getChildGroups(b),e=j(d,c),e?(f=a.getGroupId(e),m(f)):(g=a.getGroup(b),h=a.getContainerId(g),h?k(h,b):a.isLoop(g)&&m(b))):(c=a.getFirstGroupId(),m(c))}function l(b){var c,d,e,f;c=a.getChildGroups(b),c.length?(e=a.getGroupId(c[0]),m(e)):(d=a.getGroup(b),f=a.getContainerId(d),k(f,b))}function m(c,d){var e,f;c?(e=a.getGroupElements(c),f=i(e,d),f?b(f):l(c)):k()}function n(b,c){var d,e,f,g,i;b?(d=a.getChildGroups(b),e=h(d,c),e?(f=a.getGroupId(e),o(f)):(g=a.getGroup(b),i=a.getContainerId(g),i?n(i,b):p(b))):(c=a.getLastGroupId(),o(c))}function o(b){var c,d;b?(c=a.getChildGroups(b),c.length?(d=a.getGroupId(c[c.length-1]),o(d)):p(b)):n()}function p(c,d){var e,f,h,i;c?(e=a.getGroupElements(c),f=g(e,d),f?b(f):(h=a.getGroup(c),i=a.getContainerId(h),i?n(i,c):a.isLoop(h)&&o(c))):o()}var q=this;this.activeElement=null,this.focus=b,this.prev=e,this.next=d,this.canReceiveFocus=c}),a.service("focusMouse",function(a){function b(){e.muted=!1,document.removeEventListener("mousedown",d)}function c(){e.muted=!1,document.addEventListener("mousedown",d)}function d(b){e.muted||a.canReceiveFocus(b.target)&&a.focus(b.target)}var e=this;this.muted=!1,this.mute=b,this.unmute=c}).run(function(a){a.unmute()}),a.service("focusQuery",function(){function a(a){var b=new RegExp(a.nodeName.toUpperCase()).test(G);return b||(b=null!==a.getAttribute("tabindex")),b&&(b=null===a.getAttribute("disabled")),b&&(b=x(a).isVisible()),b}function b(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:C,focusContainerId:B}),b=document.querySelector(a);return o(b)}function c(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:C,focusContainerId:B}),b=document.querySelectorAll(a);return o(b[b.length-1])}function d(a){return document.querySelectorAll('[{focusContainerId}="{groupId}"]'.supplant({focusContainerId:B,groupId:a}))}function e(a){var b="A:not({focusParentId}),SELECT:not({focusParentId}),BUTTON:not({focusParentId}),INPUT:not({focusParentId}),TEXTAREA:not({focusParentId}),*[tabindex]:not({focusParentId})";return b=b.supplant({focusParentId:"["+A+"]"}),a.querySelectorAll(b)}function f(a){var b="["+z+"]:not(["+B+"])";return a.querySelectorAll(b)}function g(a){for(var b,c='[{focusParentId}="{groupId}"]:not([disabled]):not(.disabled)'.supplant({focusParentId:A,groupId:a}),d=document.querySelectorAll(c),e=[],f=0,g=d.length;g>f;)b=x(d[f]),b.isVisible(!0)?(e.push(d[f]),f+=1):f+=1;return e}function h(a){return"autofocus"===a.getAttribute(D)}function i(a){return"false"!==a.getAttribute(E)}function j(a){return"true"===a.getAttribute(F)}function k(a){var b='[{focusElementId}="{elementId}"]'.supplant({focusElementId:y,elementId:a});return document.querySelector(b)}function l(a){return document.querySelector("["+z+'="'+a+'"]')}function m(a){return a.getAttribute(y)}function n(a,b){a.setAttribute(y,b)}function o(a){return a.getAttribute(z)}function p(a,b){a.setAttribute(z,b)}function q(a){return a.getAttribute(A)}function r(a,b){a.setAttribute(A,b)}function s(a){return a.getAttribute(B)}function t(a,b){a.setAttribute(B,b)}function u(a){var b=l(a);return s(b)}function v(a){return isNaN(a)&&(a=this.parentId(a)),document.querySelector("["+z+'="'+a+'"]')}function w(a,b){for(var c=b.parentNode;9!==c.nodeType;){if(c===a)return!0;c=c.parentNode}return!1}var x=$,y="focus-element-id",z="focus-group-id",A="focus-parent-id",B="focus-container-id",C="focus-group",D="focus-element",E="focus-enabled",F="focus-loop",G="A,SELECT,BUTTON,INPUT,TEXTAREA,*[tabindex]";this.getElement=k,this.getElementId=m,this.setElementId=n,this.getGroupId=o,this.setGroupId=p,this.getParentId=q,this.setParentId=r,this.getContainerId=s,this.setContainerId=t,this.getContainerIdByGroupId=u,this.getGroup=l,this.getFirstGroupId=b,this.getLastGroupId=c,this.getElementsWithoutParents=e,this.getGroupsWithoutContainers=f,this.isAutofocus=h,this.isLoop=j,this.isEnabled=i,this.group=v,this.getGroupElements=g,this.getChildGroups=d,this.contains=w,this.canReceiveFocus=a})}()}({},function(){return this}());