/*
* uxFocusManager v.0.0.1
* (c) 2014, WebUX
* https://github.com/webux/ux-angular-focusmanager
* License: MIT.
*/
!function(a,b){b.ux=a,function(){var a;try{a=angular.module("ux")}catch(b){a=angular.module("ux",[])}var c={};c.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments;clearTimeout(d),d=setTimeout(function(){d=null,c||a.apply(e,f)},b),c&&!d&&a.apply(e,f)}},c.throttle=function(a,b,c){b||(b=250);var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&d+b>g?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}},a.directive("focusElement",function(a,b){return{link:function(c,d){var e=d[0];b.isAutofocus(e)&&setTimeout(function(){a.focus(e)})}}}),a.directive("focusGroup",function(a,b){function d(b){var c,d,e,h,i="group-"+f;for(a.setGroupId(b,i),c=a.getElementsWithoutParents(b),e=c.length,d=0;e>d;)h="element-"+g,a.setParentId(c[d],i),a.setElementId(c[d],h),g+=1,d+=1;for(c=a.getGroupsWithoutContainers(b),e=c.length,d=0;e>d;)a.setContainerId(c[d],i),d+=1;return f+=1,i}function e(b,e){var f=e[0],g=null,i=!1;setTimeout(function(){a.getContainerId(f)||h.on("focusin",c.debounce(function(c){a.contains(f,c.newTarget)?i===!1&&(i=!0,b.$broadcast("bindKeys",g)):i===!0&&(i=!1,b.$broadcast("unbindKeys"))},100))},10),g=d(f)}var f=1,g=1,h=b();return{scope:!0,link:e}}),a.directive("focusHighlight",function(a,b){var d=b();return{scope:!0,replace:!0,link:function(a,b){var e=b[0];d.on("focusin",c.throttle(function(a){var b=a.newTarget.getBoundingClientRect();e.style.left=b.left+"px",e.style.top=b.top+"px",e.style.width=b.width+"px",e.style.height=b.height+"px"},100))},template:'<div class="focus-highlight"></div>'}}),a.directive("focusKeyboard",function(a){return{link:function(b,c,d){var e=!1;d.focusKeyboard&&(b.$on("bindKeys",function(){e||(e=!0,Mousetrap.bind(d.focusKeyboard.split(","),function(b){return b.preventDefault(),b.stopPropagation(),a.focus(c[0]),!1}))}),b.$on("unbindKeys",function(){e&&(e=!1,Mousetrap.unbind(d.focusKeyboard.split(",")))}))}}}),String.prototype.supplant=function(a){"use strict";return this.replace(/{([^{}]*)}/g,function(b,c){var d=a[c];return"string"==typeof d||"number"==typeof d?d:b})},a.factory("focusDispatcher",function(){function a(){this.events={}}function b(b){return b=b||"fm",c[b]||(c[b]=new a),c[b]}var c={};return a.prototype.events={},a.prototype.on=function(a,b){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push(b)},a.prototype.off=function(a,b){if(this.events.hasOwnProperty(a))for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)},a.prototype.trigger=function(a,b){if(this.events.hasOwnProperty(a)){b=b||{},b.currentTarget=this;for(var c in this.events[a])this.events[a][c](b)}},b}),a.service("focusKeyboard",function(){function a(a,b){e[a.trim().toLowerCase()]={muted:!1,callback:b}}function b(a){delete e[a.trim().toLowerCase()]}function c(a){var b=e[a.trim().toLowerCase()];b&&(b.muted=!0)}function d(a){var b=e[a.trim().toLowerCase()];b&&(b.muted=!1)}var e={};document.addEventListener("keydown",function(a){var b="";a.shiftKey&&(b+="shift+"),9===a.keyCode&&(b+="tab");var c=e[b];c&&c.callback&&!c.muted&&(a.preventDefault(),a.stopPropagation(),c.callback())}),this.register=a,this.unregister=b,this.mute=c,this.unmute=d}).run(function(a,b){a.register("TAB",b.next),a.register("SHIFT+TAB",b.prev)}),a.service("focusModel",function(a,b){function c(a){if("undefined"==typeof a)return r.activeElement;if(r.activeElement!==a){var b={oldTarget:r.activeElement,newTarget:a};s.trigger("focusout",b),r.activeElement=a,a.focus(),s.trigger("focusin",b)}}function d(b){return a.canReceiveFocus(b)}function e(){var b,c;r.activeElement?(b=a.getParentId(r.activeElement),c=a.getElementId(r.activeElement),n(b,c)):n()}function f(){var b,c;r.activeElement?(b=a.getParentId(r.activeElement),c=a.getElementId(r.activeElement),q(b,c)):q()}function g(a,b){for(var c=0,d=a.length;d>c;){if(a[c]===b)return c;c+=1}return-1}function h(b,c){var d,e;if(b&&b.length){if(!c)return b[b.length-1];if(d=a.getElement(c),e=g(b,d),e>0)return b[e-1]}}function i(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getGroup(c),e=g(b,d),e>0)return b[e-1]}}function j(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getElement(c),e=g(b,d),-1!==e&&e+1<b.length)return b[e+1]}}function k(b,c){var d,e;return b&&(d=a.getGroup(c),e=g(b,d),-1!==e&&e+1<b.length)?b[e+1]:void 0}function l(b,c){var d,e,f,g,h;c?(d=a.getChildGroups(b),e=k(d,c),e?(f=a.getGroupId(e),n(f)):(g=a.getGroup(b),h=a.getContainerId(g),h?l(h,b):a.isLoop(g)&&n(b))):(c=a.getFirstGroupId(),n(c))}function m(b){var c,d,e,f;c=a.getChildGroups(b),c.length?(e=a.getGroupId(c[0]),n(e)):(d=a.getGroup(b),f=a.getContainerId(d),l(f,b))}function n(b,d){var e,f;b?(e=a.getGroupElements(b),f=j(e,d),f?c(f):m(b)):l()}function o(b,c){var d,e,f,g,h;b?(d=a.getChildGroups(b),e=i(d,c),e?(f=a.getGroupId(e),p(f)):(g=a.getGroup(b),h=a.getContainerId(g),h?o(h,b):q(b))):(c=a.getLastGroupId(),p(c))}function p(b){var c,d;b?(c=a.getChildGroups(b),c.length?(d=a.getGroupId(c[c.length-1]),p(d)):q(b)):o()}function q(b,d){var e,f,g,i;b?(e=a.getGroupElements(b),f=h(e,d),f?c(f):(g=a.getGroup(b),i=a.getContainerId(g),i?o(i,b):a.isLoop(g)&&p(b))):p()}var r=this,s=b();this.activeElement=null,this.focus=c,this.prev=f,this.next=e,this.canReceiveFocus=d}),a.service("focusMouse",function(a){function b(){e.muted=!1,document.removeEventListener("mousedown",d)}function c(){e.muted=!1,document.addEventListener("mousedown",d)}function d(b){e.muted||a.canReceiveFocus(b.target)&&a.focus(b.target)}var e=this;this.muted=!1,this.mute=b,this.unmute=c}).run(function(a){a.unmute()}),a.service("focusQuery",function(){function a(a){var b=new RegExp(a.nodeName.toUpperCase()).test(G);return b||(b=null!==a.getAttribute("tabindex")),b&&(b=null===a.getAttribute("disabled")),b&&(b=x(a).isVisible()),b}function b(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:C,focusContainerId:B}),b=document.querySelector(a);return o(b)}function c(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:C,focusContainerId:B}),b=document.querySelectorAll(a);return o(b[b.length-1])}function d(a){return document.querySelectorAll('[{focusContainerId}="{groupId}"]'.supplant({focusContainerId:B,groupId:a}))}function e(a){var b="A:not({focusParentId}),SELECT:not({focusParentId}),BUTTON:not({focusParentId}),INPUT:not({focusParentId}),TEXTAREA:not({focusParentId}),*[tabindex]:not({focusParentId})";return b=b.supplant({focusParentId:"["+A+"]"}),a.querySelectorAll(b)}function f(a){var b="["+z+"]:not(["+B+"])";return a.querySelectorAll(b)}function g(a){for(var b,c='[{focusParentId}="{groupId}"]:not([disabled]):not(.disabled)'.supplant({focusParentId:A,groupId:a}),d=document.querySelectorAll(c),e=[],f=0,g=d.length;g>f;)b=x(d[f]),b.isVisible(!0)?(e.push(d[f]),f+=1):f+=1;return e}function h(a){return"autofocus"===a.getAttribute(D)}function i(a){return"false"!==a.getAttribute(E)}function j(a){return"true"===a.getAttribute(F)}function k(a){var b='[{focusElementId}="{elementId}"]'.supplant({focusElementId:y,elementId:a});return document.querySelector(b)}function l(a){return document.querySelector("["+z+'="'+a+'"]')}function m(a){return a.getAttribute(y)}function n(a,b){a.setAttribute(y,b)}function o(a){return a.getAttribute(z)}function p(a,b){a.setAttribute(z,b)}function q(a){return a.getAttribute(A)}function r(a,b){a.setAttribute(A,b)}function s(a){return a.getAttribute(B)}function t(a,b){a.setAttribute(B,b)}function u(a){var b=l(a);return s(b)}function v(a){return isNaN(a)&&(a=this.parentId(a)),document.querySelector("["+z+'="'+a+'"]')}function w(a,b){for(var c=b.parentNode;9!==c.nodeType;){if(c===a)return!0;c=c.parentNode}return!1}var x=$,y="focus-element-id",z="focus-group-id",A="focus-parent-id",B="focus-container-id",C="focus-group",D="focus-element",E="focus-enabled",F="focus-loop",G="A,SELECT,BUTTON,INPUT,TEXTAREA,*[tabindex]";this.getElement=k,this.getElementId=m,this.setElementId=n,this.getGroupId=o,this.setGroupId=p,this.getParentId=q,this.setParentId=r,this.getContainerId=s,this.setContainerId=t,this.getContainerIdByGroupId=u,this.getGroup=l,this.getFirstGroupId=b,this.getLastGroupId=c,this.getElementsWithoutParents=e,this.getGroupsWithoutContainers=f,this.isAutofocus=h,this.isLoop=j,this.isEnabled=i,this.group=v,this.getGroupElements=g,this.getChildGroups=d,this.contains=w,this.canReceiveFocus=a}),function(a,b,c){function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}function e(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return q[a.which]?q[a.which]:r[a.which]?r[a.which]:String.fromCharCode(a.which).toLowerCase()}function f(a){a=a||{};var b,c=!1;for(b in w)a[b]?c=!0:w[b]=0;c||(z=!1)}function g(a,b,c,d,e,f){var g,h,i=[],j=c.type;if(!u[a])return[];for("keyup"==j&&k(a)&&(b=[a]),g=0;g<u[a].length;++g)if(h=u[a][g],!(!d&&h.seq&&w[h.seq]!=h.level||j!=h.action||("keypress"!=j||c.metaKey||c.ctrlKey)&&b.sort().join(",")!==h.modifiers.sort().join(","))){var l=d&&h.seq==d&&h.level==f;(!d&&h.combo==e||l)&&u[a].splice(g,1),i.push(h)}return i}function h(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function i(a,b,c,d){A.stopCallback(b,b.target||b.srcElement,c,d)||!1!==a(b,c)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function j(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=e(a);b&&("keyup"==a.type&&x===b?x=!1:A.handleKey(b,h(a),a))}function k(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function l(a,b,c,d){function g(b){return function(){z=b,++w[a],clearTimeout(p),p=setTimeout(f,1e3)}}function h(b){i(c,b,a),"keyup"!==d&&(x=e(b)),setTimeout(f,10)}for(var j=w[a]=0;j<b.length;++j){var k=j+1===b.length?h:g(d||m(b[j+1]).action);n(b[j],k,d,a,j)}}function m(a,b){var c,d,e,f=[];for(c="+"===a?["+"]:a.split("+"),e=0;e<c.length;++e)d=c[e],t[d]&&(d=t[d]),b&&"keypress"!=b&&s[d]&&(d=s[d],f.push("shift")),k(d)&&f.push(d);if(c=d,e=b,!e){if(!o){o={};for(var g in q)g>95&&112>g||q.hasOwnProperty(g)&&(o[q[g]]=g)}e=o[c]?"keydown":"keypress"}return"keypress"==e&&f.length&&(e="keydown"),{key:d,modifiers:f,action:e}}function n(a,b,c,d,e){v[a+":"+c]=b,a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?l(a,f,b,c):(c=m(a,c),u[c.key]=u[c.key]||[],g(c.key,c.modifiers,{type:c.action},d,a,e),u[c.key][d?"unshift":"push"]({callback:b,modifiers:c.modifiers,action:c.action,seq:d,level:e,combo:a}))}var o,p,q={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},r={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},s={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},t={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},u={},v={},w={},x=!1,y=!1,z=!1;for(c=1;20>c;++c)q[111+c]="f"+c;for(c=0;9>=c;++c)q[c+96]=c;d(b,"keypress",j),d(b,"keydown",j),d(b,"keyup",j);var A={bind:function(a,b,c){a=a instanceof Array?a:[a];for(var d=0;d<a.length;++d)n(a[d],b,c);return this},unbind:function(a,b){return A.bind(a,function(){},b)},trigger:function(a,b){return v[a+":"+b]&&v[a+":"+b]({},a),this},reset:function(){return u={},v={},this},stopCallback:function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:function(a,b,c){var d,e=g(a,b,c);b={};var h=0,j=!1;for(d=0;d<e.length;++d)e[d].seq&&(h=Math.max(h,e[d].level));for(d=0;d<e.length;++d)e[d].seq?e[d].level==h&&(j=!0,b[e[d].seq]=1,i(e[d].callback,c,e[d].combo,e[d].seq)):j||i(e[d].callback,c,e[d].combo);e="keypress"==c.type&&y,c.type!=z||k(a)||e||f(b),y=j&&"keydown"==c.type}};a.Mousetrap=A,"function"==typeof define&&define.amd&&define(A)}(window,document)}()}({},function(){return this}());