/*
* angular-ux-focusmanager v.0.1.4
* (c) 2014, WebUX
* https://github.com/webux/angular-ux-focusmanager
* License: MIT.
*/
!function(){function a(a,b){"use strict";return a.replace?a.replace(/{([^{}]*)}/g,function(a,c){var d=b[c];return"string"==typeof d||"number"==typeof d?d:a}):b}var b;try{b=angular.module("ux")}catch(c){b=angular.module("ux",[])}var d={};d.addEvent=function(a,b,c){return a.addEventListener?void a.addEventListener(b,c,!1):void a.attachEvent("on"+b,c)},d.removeEvent=function(a,b,c){return a.removeEventListener?void a.removeEventListener(b,c,!1):void a.detachEvent("on"+b,c)},d.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments;clearTimeout(d),d=setTimeout(function(){d=null,c||a.apply(e,f)},b),c&&!d&&a.apply(e,f)}},d.throttle=function(a,b,c){b=b||250;var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&d+b>g?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}},angular.module("ux").directive("focusElement",["focusManager","focusQuery",function(a,b){return{link:function(c,d){var e=d[0];if(b.isAutofocus(e))var f=c.$watch(function(){f(),a.focus(e);var b=setInterval(function(){a.focus()!==e||document.activeElement===e?clearInterval(b):e.focus()},10)})}}}]),angular.module("ux").directive("focusGroup",["focusManager","focusQuery","focusDispatcher",function(a,b,c){function e(a,c){var d,e,f,g;for(d=b.getElementsWithoutParents(c),f=d.length,e=0;f>e;){g=h,b.setParentId(d[e],a),b.setElementId(d[e],g);var i=b.getTabIndex(d[e]);(void 0===i||null===i)&&b.setTabIndex(d[e],-1),h+=1,e+=1}for(d=b.getGroupsWithoutParentGroup(c),f=d.length,e=0;f>e;)b.setParentGroupId(d[e],a),e+=1}function f(c,f){function h(){c.$on("focus::"+n,function(){e(n,m),k()}),b.getParentGroupId(m)||(p=m.innerHTML,c.$watch(d.debounce(function(){if(q=m.innerHTML,p!==q){for(var a,b=m.querySelectorAll("["+focusGroup+"]"),d=b.length;d;)d-=1,a=b[d].getAttribute(focusGroupId),c.$broadcast("focus::"+a);p=q}e(n,m),k()},j)),i.on("focusin",d.debounce(function(a){b.contains(m,a.newTarget)?o===!1&&(o=!0,c.$broadcast("bindKeys",n)):o===!0&&(o=!1,c.$broadcast("unbindKeys"))},j)))}function k(){a.callback=function(a){b.setTabIndex(a,0)},a.findPrevChildGroup(n),a.findNextElement(n),a.callback=null}function l(){a.enable()}var m=f[0],n=g++,o=!1,p="",q="";m.addEventListener("focus",l,!0),setTimeout(h,j),b.setGroupId(m,n),e(n,m)}var g=1,h=1,i=c(),j=100;return{link:f}}]),angular.module("ux").factory("focusDispatcher",function(){function a(){this.events={}}function b(b){return b=b||"fm",c[b]||(c[b]=new a),c[b]}var c={};return a.prototype.events={},a.prototype.on=function(a,b){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push(b)},a.prototype.off=function(a,b){if(this.events.hasOwnProperty(a))for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)},a.prototype.trigger=function(a,b){if(this.events.hasOwnProperty(a)){b=b||{},b.currentTarget=this;for(var c in this.events[a])this.events[a][c](b)}},b}),angular.module("ux").service("focusKeyboard",["focusManager",function(a){function b(){o||(o=!0)}function c(){o&&(o=!1)}function e(){p||(p=!0)}function f(){p&&(p=!1)}function g(){o?(c(),e()):(b(),f())}function h(a){a.preventDefault(),a.stopPropagation();var b=a.target;k(b,"mousedown"),k(b,"mouseup"),k(b,"click")}function i(b){return a.enabled&&a.next(),a.enabled?(b.preventDefault(),b.stopPropagation(),!1):void 0}function j(b){return a.enabled&&a.prev(),a.enabled?(b.preventDefault(),b.stopPropagation(),!1):void 0}function k(a,b){var c,d;if(a.ownerDocument?c=a.ownerDocument:9===a.nodeType&&(c=a),a.dispatchEvent){var e="";switch(b){case"click":case"mousedown":case"mouseup":e="MouseEvents"}d=c.createEvent(e);var f="change"===b?!1:!0;d.initEvent(b,f,!0),d.synthetic=!0,a.dispatchEvent(d,!0)}else a.fireEvent&&(d=c.createEventObject(),d.synthetic=!0,a.fireEvent("on"+b,d))}function l(){d.addEvent(document,"keydown",n)}function m(){d.removeEvent(document,"keydown",n)}function n(a){o&&9===a.keyCode&&(a.shiftKey?j(a):i(a)),p&&(a.shiftKey||a.altKey||a.ctrlKey||(37===a.keyCode?j(a):38===a.keyCode?j(a):39===a.keyCode?i(a):40===a.keyCode&&i(a))),a.shiftKey||a.altKey||a.ctrlKey||13===a.keyCode&&h(a)}var o=!1,p=!1;this.enable=l,this.disable=m,this.enableTabKeys=b,this.disableTabKeys=c,this.enableArrowKeys=e,this.disableArrowKeys=f,this.toggleTabArrowKeys=g,this.triggerClick=h}]).run(["focusKeyboard",function(a){a.enable(),a.enableTabKeys()}]),angular.module("ux").service("focusManager",["focusQuery","focusDispatcher",function(a,b){function c(a){if("undefined"==typeof a)return x.activeElement;if(x.activeElement!==a){var b={oldTarget:x.activeElement,newTarget:a};y.trigger("focusout",b),x.activeElement=a,a.focus(),y.trigger("focusin",b)}}function d(b){return a.canReceiveFocus(b)}function e(){var b,c;x.activeElement?(b=a.getParentId(x.activeElement),c=a.getElementId(x.activeElement),o(b,c)):o()}function f(){var b,c;x.activeElement?(b=a.getParentId(x.activeElement),c=a.getElementId(x.activeElement),r(b,c)):r()}function g(a,b){for(var c=0,d=a.length;d>c;){if(a[c]===b)return c;c+=1}return-1}function h(b,c){var d,e;if(b&&b.length){if(!c)return b[b.length-1];if(d=a.getElement(c),e=g(b,d),e>0)return b[e-1]}}function i(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getGroup(c),e=g(b,d),e>0)return b[e-1]}}function j(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getElement(c),e=g(b,d),-1!==e&&e+1<b.length)return b[e+1]}}function k(b,c){var d,e;return b&&(d=a.getGroup(c),e=g(b,d),-1!==e&&e+1<b.length)?b[e+1]:void 0}function l(b,c){var d,e,f,g,h,i,j;return d=a.getGroup(c),j=a.hasGroupTail(d),!j&&b?(b=a.getParentGroupId(d),e=a.getChildGroups(b),f=k(e,c),f?(g=a.getGroupId(f),o(g)):(h=a.getGroup(b),i=a.getParentGroupId(h),l(i,b))):void m(c)}function m(b){var c,d;if(c=a.getGroup(b),d=a.getGroupTail(c),b){if("stop"===d)return;if(!d)return void w()}else b=a.getFirstGroupId();o(b)}function n(b){var c,d,e,f;c=a.getChildGroups(b),c.length?(e=a.getGroupId(c[0]),o(e)):(d=a.getGroup(b),f=a.getParentGroupId(d),l(f,b))}function o(b,d){var e,f;b?(e=a.getGroupElements(b),f=j(e,d),f?x.callback?x.callback(f):c(f):n(b)):l()}function p(b,c){var d,e,f;b?(d=a.getChildGroups(b),e=i(d,c),e?(f=a.getGroupId(e),q(f)):r(b)):(c=a.getLastGroupId(),q(c))}function q(b){var c,d;b?(c=a.getChildGroups(b),c.length?(d=a.getGroupId(c[c.length-1]),q(d)):r(b)):p()}function r(b,d){var e,f;b?(e=a.getGroupElements(b),f=h(e,d),f?x.callback?x.callback(f):c(f):s(b)):q()}function s(b){var c,d,e;if(d=a.getGroup(b),e=a.hasGroupHead(d),c=a.getParentGroupId(d),e||!c){var f=a.getGroupHead(d);"loop"===f?q(b):f||w()}else p(c,b)}function t(){x.active=!0}function u(){x.active=!1}function v(){!x.enabled&&x.active&&(x.enabled=!0,x.activeElement=document.activeElement,y.trigger("enabled"))}function w(){x.enabled&&(x.enabled=!1,y.trigger("disabled"))}var x=this,y=b();this.active=!0,this.enabled=!1,this.activeElement=null,this.focus=c,this.prev=f,this.next=e,this.findPrevChildGroup=q,this.findNextElement=o,this.canReceiveFocus=d,this.on=t,this.off=u,this.enable=v,this.disable=w}]),angular.module("ux").service("focusMouse",["focusManager","focusQuery",function(a,b){function c(){g.enabled=!1,d.addEvent(document,"mousedown",f)}function e(){g.enabled=!1,d.removeEvent(document,"mousedown",f)}function f(c){if(a.canReceiveFocus(c.target)){a.focus(c.target);var d=b.getParentId(c.target);d?a.enable():a.disable()}}var g=this;this.enabled=!1,this.enable=c,this.disable=e}]).run(["focusMouse",function(a){a.enable()}]),angular.module("ux").service("focusQuery",function(){function b(a){if(!a)return!1;var b=new RegExp(a.nodeName.toUpperCase()).test(selectable);return b||(b=a.hasAttribute(focusIndex)),b||(b=a.hasAttribute(tabIndex)&&a.getAttribute(tabIndex)>-1),b&&(b=!a.hasAttribute("disabled")),b&&(b=i(a)),b}function c(){var b=a("[{focusGroup}]:not([{focusParentGroupId}])",{focusGroup:focusGroup,focusParentGroupId:focusParentGroupId}),c=document.querySelector(b);return u(c)}function d(){var b=a("[{focusGroup}]:not([{focusParentGroupId}])",{focusGroup:focusGroup,focusParentGroupId:focusParentGroupId}),c=document.querySelectorAll(b);return u(c[c.length-1])}function e(b){for(var c=a('[{focusParentGroupId}="{groupId}"]',{focusParentGroupId:focusParentGroupId,groupId:b}),d=document.querySelectorAll(c),e=[],f=0,g=d.length;g>f;)e.push(d[f]),f+=1;return e=D(e,F)}function f(b){if(b){var c="A:not({focusParentId}),SELECT:not({focusParentId}),BUTTON:not({focusParentId}),INPUT:not({focusParentId}),TEXTAREA:not({focusParentId}),*[focus-index]:not({focusParentId})";return c=a(c,{focusParentId:"["+focusParentId+"]"}),b.querySelectorAll(c)}return[]}function g(a){if(!a)return[];var b="["+focusGroupId+"]:not(["+focusParentGroupId+"])";return a.querySelectorAll(b)}function h(b){var c,d,e,f,g,h;for(d=r(b),c=d?a('[{focusParentId}="{groupId}"][focus-index]:not([disabled]):not(.disabled)',{focusParentId:focusParentId,groupId:b}):a('[{focusParentId}="{groupId}"]:not([disabled]):not(.disabled)',{focusParentId:focusParentId,groupId:b}),e=document.querySelectorAll(c),f=[],g=0,h=e.length;h>g;)i(e[g])?(f.push(e[g]),g+=1):g+=1;return f=D(f,E)}function i(a){return a?9===a.parentNode.nodeType?!0:0===a.offsetWidth||0===a.offsetHeight?!1:"none"===a.style.display?!1:"hidden"===a.style.visibility?!1:0===a.style.opacity||"0"===a.style.opacity?!1:!0:!1}function j(a){return a?"autofocus"===a.getAttribute(focusElement):!1}function k(a){return a?"false"!==a.getAttribute(focusEnabled):!1}function l(a){return a?a.hasAttribute(focusGroupHead):!1}function m(a){return a?a.getAttribute(focusGroupHead):void 0}function n(a){return a?a.hasAttribute(focusGroupTail):!1}function o(a){return a?a.getAttribute(focusGroupTail):void 0}function p(b){if(b){var c=a('[{focusElementId}="{elementId}"]',{focusElementId:focusElementId,elementId:b});return document.querySelector(c)}}function q(a){return a?document.querySelector("["+focusGroupId+'="'+a+'"]'):void 0}function r(a){var b=q(a);return b?"strict"===b.getAttribute(focusGroup):!1}function s(a){return a?a.getAttribute(focusElementId):void 0}function t(a,b){a.setAttribute(focusElementId,b)}function u(a){return a?a.getAttribute(focusGroupId):void 0}function v(a,b){a.setAttribute(focusGroupId,b)}function w(a){return a?a.getAttribute(focusParentId):void 0}function x(a,b){a.setAttribute(focusParentId,b)}function y(a){return a?a.getAttribute(focusParentGroupId):void 0}function z(a,b){a.setAttribute(focusParentGroupId,b)}function A(a){return a?a.getAttribute(tabIndex):void 0}function B(a,b){a&&(null===b?a.removeAttribute(tabIndex):a.setAttribute(tabIndex,b))}function C(a,b){if(b){var c=b.parentNode;if(c)for(;c&&9!==c.nodeType;){if(c===a)return!0;c=c.parentNode}}return!1}function D(a,b){var c,d=0,e=a.length-1;for(b||(b=function(a,b){return a>b?1:b>a?-1:0});e>d;)b(a[d],a[d+1])>0&&(c=a[d+1],a[d+1]=a[d],a[d]=c),d+=1;return a}function E(a,b){var c=a.getAttribute(focusIndex)||Number.POSITIVE_INFINITY,d=b.getAttribute(focusIndex)||Number.POSITIVE_INFINITY;return d>c?-1:c>d?1:0}function F(a,b){var c=a.getAttribute(focusGroupIndex)||Number.POSITIVE_INFINITY,d=b.getAttribute(focusGroupIndex)||Number.POSITIVE_INFINITY;return d>c?-1:c>d?1:0}this.getElement=p,this.getElementId=s,this.setElementId=t,this.getGroupId=u,this.setGroupId=v,this.getParentId=w,this.setParentId=x,this.getParentGroupId=y,this.setParentGroupId=z,this.getGroup=q,this.getFirstGroupId=c,this.getLastGroupId=d,this.getTabIndex=A,this.setTabIndex=B,this.getElementsWithoutParents=f,this.getGroupsWithoutParentGroup=g,this.isAutofocus=j,this.hasGroupHead=l,this.hasGroupTail=n,this.getGroupHead=m,this.getGroupTail=o,this.isEnabled=k,this.getGroupElements=h,this.getChildGroups=e,this.contains=C,this.canReceiveFocus=b})}();