/*
* angular-ux-focusmanager v.0.1.0
* (c) 2014, WebUX
* https://github.com/webux/angular-ux-focusmanager
* License: MIT.
*/
!function(){var a;try{a=angular.module("ux")}catch(b){a=angular.module("ux",[])}var c={};c.addEvent=function(a,b,c){return a.addEventListener?void a.addEventListener(b,c,!1):void a.attachEvent("on"+b,c)},c.removeEvent=function(a,b,c){return a.removeEventListener?void a.removeEventListener(b,c,!1):void a.detachEvent("on"+b,c)},c.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments;clearTimeout(d),d=setTimeout(function(){d=null,c||a.apply(e,f)},b),c&&!d&&a.apply(e,f)}},c.throttle=function(a,b,c){b=b||250;var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&d+b>g?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}},String.prototype.supplant=function(a){"use strict";return this.replace(/{([^{}]*)}/g,function(b,c){var d=a[c];return"string"==typeof d||"number"==typeof d?d:b})},angular.module("ux").directive("focusElement",["focusManager","focusQuery",function(a,b){return{link:function(c,d){var e=d[0];b.isAutofocus(e)&&setTimeout(function(){a.focus(e)})}}}]),angular.module("ux").directive("focusGroup",["focusManager","focusQuery","focusDispatcher",function(a,b,d){function e(a,c){var d,e,f,g;for(d=b.getElementsWithoutParents(c),f=d.length,e=0;f>e;)g="element-"+h,b.setParentId(d[e],a),b.setElementId(d[e],g),b.setTabIndex(d[e],-1),h+=1,e+=1;for(d=b.getGroupsWithoutContainers(c),f=d.length,e=0;f>e;)b.setContainerId(d[e],a),e+=1;return a}function f(d,f){function h(){d.$on("focus::"+m,function(){e(m,l)}),b.getContainerId(l)||(o=l.innerHTML,p=o.match(/<\w+/g).length,d.$watch(c.debounce(function(){if(q=l.innerHTML,o!==q){if(r=q.match(/<\w+/g).length,p!==r)for(var a,b=l.querySelectorAll("[focus-group]"),c=b.length;c;)c-=1,a=b[c].getAttribute("focus-group-id"),d.$broadcast("focus::"+a);o=q,p=r}},j)),i.on("focusin",c.debounce(function(a){b.contains(l,a.newTarget)?n===!1&&(n=!0,d.$broadcast("bindKeys",m)):n===!0&&(n=!1,d.$broadcast("unbindKeys"))},j)),a.callback=function(a){b.setTabIndex(a,null)},a.findPrevChildGroup(m),a.findNextElement(m),a.callback=null)}function k(){a.enable()}var l=f[0],m="group-"+g++,n=!1,o="",p=0,q="",r=0;l.addEventListener("focus",k,!0),setTimeout(h,j),b.setGroupId(l,m),e(m,l)}var g=1,h=1,i=d(),j=100;return{link:f}}]),angular.module("ux").factory("focusDispatcher",function(){function a(){this.events={}}function b(b){return b=b||"fm",c[b]||(c[b]=new a),c[b]}var c={};return a.prototype.events={},a.prototype.on=function(a,b){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push(b)},a.prototype.off=function(a,b){if(this.events.hasOwnProperty(a))for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)},a.prototype.trigger=function(a,b){if(this.events.hasOwnProperty(a)){b=b||{},b.currentTarget=this;for(var c in this.events[a])this.events[a][c](b)}},b}),angular.module("ux").service("focusKeyboard",["focusManager",function(a){function b(){o||(o=!0)}function d(){o&&(o=!1)}function e(){p||(p=!0)}function f(){p&&(p=!1)}function g(){o?(d(),e()):(b(),f())}function h(a){a.preventDefault(),a.stopPropagation(),k(a.target,"mousedown"),k(a.target,"mouseup"),k(a.target,"click")}function i(b){return a.enabled&&a.next(),a.enabled?(b.preventDefault(),b.stopPropagation(),!1):void 0}function j(b){return a.enabled&&a.prev(),a.enabled?(b.preventDefault(),b.stopPropagation(),!1):void 0}function k(a,b){var c,d;if(a.ownerDocument?c=a.ownerDocument:9===a.nodeType&&(c=a),a.dispatchEvent){var e="";switch(b){case"click":case"mousedown":case"mouseup":e="MouseEvents"}d=c.createEvent(e);var f="change"===b?!1:!0;d.initEvent(b,f,!0),d.synthetic=!0,a.dispatchEvent(d,!0)}else a.fireEvent&&(d=c.createEventObject(),d.synthetic=!0,a.fireEvent("on"+b,d))}function l(){c.addEvent(document,"keydown",n)}function m(){c.removeEvent(document,"keydown",n)}function n(a){o&&9===a.keyCode&&(a.shiftKey?j(a):i(a)),p&&(a.shiftKey||a.altKey||a.ctrlKey||(37===a.keyCode?j(a):38===a.keyCode?j(a):39===a.keyCode?i(a):40===a.keyCode&&i(a))),a.shiftKey||a.altKey||a.ctrlKey||13===a.keyCode&&h(a)}var o=!1,p=!1;this.enable=l,this.disable=m,this.enableTabKeys=b,this.disableTabKeys=d,this.enableArrowKeys=e,this.disableArrowKeys=f,this.toggleTabArrowKeys=g,this.triggerClick=h}]).run(["focusKeyboard",function(a){a.enable(),a.enableTabKeys()}]),angular.module("ux").service("focusManager",["focusQuery","focusDispatcher",function(a,b){function d(a){if("undefined"==typeof a)return w.activeElement;if(w.activeElement!==a){var b={oldTarget:w.activeElement,newTarget:a};x.trigger("focusout",b),w.activeElement=a,a.focus(),x.trigger("focusin",b)}}function e(b){return a.canReceiveFocus(b)}function f(){var b,c;w.activeElement?(b=a.getParentId(w.activeElement),c=a.getElementId(w.activeElement),p(b,c)):p()}function g(){var b,c;w.activeElement?(b=a.getParentId(w.activeElement),c=a.getElementId(w.activeElement),s(b,c)):s()}function h(a,b){for(var c=0,d=a.length;d>c;){if(a[c]===b)return c;c+=1}return-1}function i(b,c){var d,e;if(b&&b.length){if(!c)return b[b.length-1];if(d=a.getElement(c),e=h(b,d),e>0)return b[e-1]}}function j(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getGroup(c),e=h(b,d),e>0)return b[e-1]}}function k(b,c){var d,e;if(b&&b.length){if(!c)return b[0];if(d=a.getElement(c),e=h(b,d),-1!==e&&e+1<b.length)return b[e+1]}}function l(b,c){var d,e;return b&&(d=a.getGroup(c),e=h(b,d),-1!==e&&e+1<b.length)?b[e+1]:void 0}function m(b,c){var d,e,f,g,h,i,j;return d=a.getGroup(c),j=a.hasGroupTail(d),!j&&b?(b=a.getContainerId(d),e=a.getChildGroups(b),f=l(e,c),f?(g=a.getGroupId(f),p(g)):(h=a.getGroup(b),i=a.getContainerId(h),m(i,b))):void n(c)}function n(b){var c,d;if(c=a.getGroup(b),d=a.getGroupTail(c),b){if("stop"===d)return;if(!d)return void v()}else b=a.getFirstGroupId();p(b)}function o(b){var c,d,e,f;c=a.getChildGroups(b),c.length?(e=a.getGroupId(c[0]),p(e)):(d=a.getGroup(b),f=a.getContainerId(d),m(f,b))}function p(b,c){var e,f;b?(e=a.getGroupElements(b),f=k(e,c),f?w.callback?w.callback(f):d(f):o(b)):m()}function q(b,c){var d,e,f,g,h;b?(d=a.getChildGroups(b),e=j(d,c),e?(f=a.getGroupId(e),r(f)):(g=a.getGroup(b),h=a.getContainerId(g),h?q(h,b):s(b))):(c=a.getLastGroupId(),r(c))}function r(b){var c,d;b?(c=a.getChildGroups(b),c.length?(d=a.getGroupId(c[c.length-1]),r(d)):s(b)):q()}function s(b,c){var e,f;b?(e=a.getGroupElements(b),f=i(e,c),f?w.callback?w.callback(f):d(f):t(b)):r()}function t(b){var c,d,e;if(d=a.getGroup(b),e=a.hasGroupHead(d),c=a.getContainerId(d),e||!c){var f=a.getGroupHead(d);"loop"===f?r(b):f||v()}else q(c,b)}function u(){w.enabled||(w.enabled=!0,w.activeElement=document.activeElement,x.trigger("enabled"))}function v(){w.enabled&&(w.enabled=!1,x.trigger("disabled"))}var w=this,x=b();this.enabled=!1,this.activeElement=null,this.focus=d,this.prev=g,this.next=f,this.findPrevChildGroup=r,this.findNextElement=p,this.canReceiveFocus=e,this.enable=c.debounce(u),this.disable=c.debounce(v)}]),angular.module("ux").service("focusMouse",["focusManager","focusQuery",function(a,b){function d(){g.enabled=!1,c.addEvent(document,"mousedown",f)}function e(){g.enabled=!1,c.removeEvent(document,"mousedown",f)}function f(c){if(a.enabled&&a.canReceiveFocus(c.target)){a.focus(c.target);var d=b.getParentId(c.target);d?a.enable():a.disable()}}var g=this;this.enabled=!1,this.enable=d,this.disable=e}]).run(["focusMouse",function(a){a.enable()}]),angular.module("ux").service("focusQuery",function(){function a(a){if(!a)return!1;var b=new RegExp(a.nodeName.toUpperCase()).test(P);return b||(b=null!==a.getAttribute(O)),b&&(b=null===a.getAttribute("disabled")),b&&(b=h(a)),b}function b(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:I,focusContainerId:G}),b=document.querySelector(a);return t(b)}function c(){var a="[{focusGroup}]:not([{focusContainerId}])".supplant({focusGroup:I,focusContainerId:G}),b=document.querySelectorAll(a);return t(b[b.length-1])}function d(a){for(var b=document.querySelectorAll('[{focusContainerId}="{groupId}"]'.supplant({focusContainerId:G,groupId:a})),c=[],d=0,e=b.length;e>d;)c.push(b[d]),d+=1;return c.sort(C),c}function e(a){if(!a)return[];var b="A:not({focusParentId}),SELECT:not({focusParentId}),BUTTON:not({focusParentId}),INPUT:not({focusParentId}),TEXTAREA:not({focusParentId}),*[focus-index]:not({focusParentId})";return b=b.supplant({focusParentId:"["+F+"]"}),a.querySelectorAll(b)}function f(a){if(!a)return[];var b="["+E+"]:not(["+G+"])";return a.querySelectorAll(b)}function g(a){var b,c,d,e,f,g;for(c=q(a),b=c?'[{focusParentId}="{groupId}"][focus-index]:not([disabled]):not(.disabled)'.supplant({focusParentId:F,groupId:a}):'[{focusParentId}="{groupId}"]:not([disabled]):not(.disabled)'.supplant({focusParentId:F,groupId:a}),d=document.querySelectorAll(b),e=[],f=0,g=d.length;g>f;)h(d[f])?(e.push(d[f]),f+=1):f+=1;return e.sort(B),e}function h(a){return a?9===a.parentNode.nodeType?!0:0===a.offsetWidth||0===a.offsetHeight?!1:"none"===a.style.display?!1:"hidden"===a.style.visibility?!1:0===a.style.opacity||"0"===a.style.opacity?!1:!0:!1}function i(a){return a?"autofocus"===a.getAttribute(M):!1}function j(a){return a?"false"!==a.getAttribute(N):!1}function k(a){return a?a.hasAttribute(K):!1}function l(a){return a?a.getAttribute(K):void 0}function m(a){return a?a.hasAttribute(L):!1}function n(a){return a?a.getAttribute(L):void 0}function o(a){var b='[{focusElementId}="{elementId}"]'.supplant({focusElementId:D,elementId:a});return document.querySelector(b)}function p(a){return a?document.querySelector("["+E+'="'+a+'"]'):void 0}function q(a){var b=p(a);return"strict"===b.getAttribute(I)}function r(a){return a?a.getAttribute(D):void 0}function s(a,b){a.setAttribute(D,b)}function t(a){return a?a.getAttribute(E):void 0}function u(a,b){a.setAttribute(E,b)}function v(a){return a?a.getAttribute(F):void 0}function w(a,b){a.setAttribute(F,b)}function x(a){return a?a.getAttribute(G):void 0}function y(a,b){a.setAttribute(G,b)}function z(a,b){a&&(null===b?a.removeAttribute(H):a.setAttribute(H,b))}function A(a,b){var c=b.parentNode;if(c)for(;9!==c.nodeType;){if(c===a)return!0;c=c.parentNode}return!1}function B(a,b){var c=a.getAttribute(O)||Number.POSITIVE_INFINITY,d=b.getAttribute(O)||Number.POSITIVE_INFINITY;return d>c?-1:c>d?1:0}function C(a,b){var c=a.getAttribute(J)||Number.POSITIVE_INFINITY,d=b.getAttribute(J)||Number.POSITIVE_INFINITY;return d>c?-1:c>d?1:0}var D="focus-element-id",E="focus-group-id",F="focus-parent-id",G="focus-container-id",H="tabindex",I="focus-group",J="focus-group-index",K="focus-group-head",L="focus-group-tail",M="focus-element",N="focus-enabled",O="focus-index",P="A,SELECT,BUTTON,INPUT,TEXTAREA,*[focus-index]";this.getElement=o,this.getElementId=r,this.setElementId=s,this.getGroupId=t,this.setGroupId=u,this.getParentId=v,this.setParentId=w,this.getContainerId=x,this.setContainerId=y,this.getGroup=p,this.getFirstGroupId=b,this.getLastGroupId=c,this.setTabIndex=z,this.getElementsWithoutParents=e,this.getGroupsWithoutContainers=f,this.isAutofocus=i,this.hasGroupHead=k,this.hasGroupTail=m,this.getGroupHead=l,this.getGroupTail=n,this.isEnabled=j,this.getGroupElements=g,this.getChildGroups=d,this.contains=A,this.canReceiveFocus=a})}();